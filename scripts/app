#!/usr/bin/env bash

# SPDX-FileCopyrightText: 2020-2021 Umbrel. https://getumbrel.com
#
# SPDX-License-Identifier: PolyForm-Noncommercial-1.0.0

set -euo pipefail

CITADEL_ROOT="$(readlink -f $(dirname "${BASH_SOURCE[0]}")/..)"

derive_entropy () {
  "${CITADEL_ROOT}/app/app-manager.py" entropy ${1}
}

app="$2"
args="${@:3}"
app_dir="${CITADEL_ROOT}/apps/${app}"
app_data_dir="${CITADEL_ROOT}/app-data/${app}"

compose() {
  local app="${1}"
  shift
  local env_file="${CITADEL_ROOT}/.env"
  local app_base_compose_file="${CITADEL_ROOT}/apps/docker-compose.common.yml"
  local app_compose_file="${app_dir}/docker-compose.yml"
  local app_entropy_identifier="app-${app}-seed"

  export BITCOIN_DATA_DIR="${CITADEL_ROOT}/bitcoin"
  export APP_DATA_DIR="${app_data_dir}"

  local dojo_hidden_service_file="${CITADEL_ROOT}/tor/data/app-${app}-dojo/hostname"
  local whirlpool_hidden_service_file="${CITADEL_ROOT}/tor/data/app-${app}-whirlpool/hostname"
  export APP_SAMOURAI_SERVER_DOJO_HIDDEN_SERVICE="$(cat "${dojo_hidden_service_file}" 2>/dev/null || echo "notyetset.onion")"
  export APP_SAMOURAI_SERVER_WHIRLPOOL_HIDDEN_SERVICE="$(cat "${whirlpool_hidden_service_file}" 2>/dev/null || echo "notyetset.onion")"
  export APP_SAMOURAI_SERVER_NODE_API_KEY=$(derive_entropy "env-${app_entropy_identifier}-NODE_API_KEY")
  export APP_SAMOURAI_SERVER_NODE_ADMIN_KEY=$(derive_entropy "env-${app_entropy_identifier}-NODE_ADMIN_KEY")
  export APP_SAMOURAI_SERVER_NODE_JWT_SECRET=$(derive_entropy "env-${app_entropy_identifier}-NODE_JWT_SECRET")
  export APP_SAMOURAI_SERVER_WHIRLPOOL_API_KEY=$(derive_entropy "env-${app_entropy_identifier}-WHIRLPOOL_API_KEY")

  docker compose \
    --env-file "${env_file}" \
    --project-name "${app}" \
    --file "${app_base_compose_file}" \
    --file "${app_compose_file}" \
    "${@}"
}

compose "${app}" ${args}
